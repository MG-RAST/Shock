
version: '3.1'

# hint: uses .env file


# optional
# set DATADIR for persistent data store , e.g. /var/tmp/Shock
# set CONFIGDIR to path to config
# set LOGDIR to path to local log dir

services:

    # the SHOCK object store
    # to make SHOCK data persistent uncomment the lines here and in "mongo" below
    shock:
        image: mgrast/shock
        depends_on:
          - shock-mongo
          - shock-mongo-seed
        entrypoint: 
          - /go/bin/shock-server 
          - --hosts=shock-mongo 
          - --basic=true                   # enables basic auth
          - --users=admin                  # spcifies that user with name "admin" is a admin
          - --force_yes=true               # avoids having shock ask interactive questions regarding db table updates
          - --debug_auth=true              # returns more detailed reasons for rejected auth
          - --api-url=http://shock:7445    # Shock returns a "preauth url", which consists of the api url
          # docker exec -ti test_shock_1 /go/bin/shock-server --hosts=shock-mongo --basic=true --users=admin --debug_auth=true
        
          #- /go/bin/shock-server
          #- --hosts=shock-mongo
          # - --conf
          # - /shock-config/shock-server.cfg
        #volumes:
          # persistent data
          #- ${DATADIR}/shock/data:/usr/local/shock
          
          # mount local source code
          #- $HOME/go/src/github.com/MG-RAST/Shock:/go/src/github.com/MG-RAST/Shock
          
          # mount config file 
          #- ${CONFIGDIR}/Shock/shock-server.container.cfg:/shock-config/shock-server.cfg
          
          # mount log directory
          #   - ${LOGDIR}/shock:/var/log/shock
          
        ports:
          - 7445:7445
          
  
  

    # mongoDB for the SHOCK service, provides metadata storage
    shock-mongo:
        image: mongo:3.6
        ports:
          - 27017
        #volumes:
          # persistent data
          #- ${DATADIR}/mongo/db:/data/db

    # create admin account
    shock-mongo-seed:
        image: mongo:3.6
        depends_on:
          - shock-mongo
        entrypoint: >
          /bin/bash -c "
            set -x
            until mongo mongodb://shock-mongo:27017/ShockDB  --eval version 
            do
              echo sleeping;
              sleep 1;
            done;
            echo Connected!;
            mongo mongodb://shock-mongo:27017/ShockDB --eval 'db.Users.updateOne({username: \"admin\"}, {$$setOnInsert: { uuid: UUID(), password: \"secret\" , shock_admin: true } } , {upsert : true})';
            mongo mongodb://shock-mongo:27017/ShockDB --eval 'db.Users.updateOne({username: \"user1\"}, {$$setOnInsert: { uuid: UUID(), password: \"secret\" , shock_admin: false } } , {upsert : true})';
          "


# create admin user manually           
#
# docker exec -ti test_shock-mongo_1 mongo ShockDB --eval 'db.Users.insert({username: "admin",  password: "secret" , shock_admin: true }  )';
         

# curl -H 'Authorization: basic dXNlcjE6c2VjcmV0'  <shock-api>/node...   # this is   user1:secret 
# curl -H 'Authorization: basic YWRtaW46c2VjcmV0'  <shock-api>/node...   # this is   admin:secret 

